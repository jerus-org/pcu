version: 2.1

# Triggered manually or via scheduled pipeline (configured in CircleCI project
# settings). Runs independently of the push-triggered config.yml.
#
# Workflow:
#   tools             - verify required tools are present and log versions
#   calculate-versions - calculate next versions for all crates and workspace
#                        BEFORE the approval gate so the reviewer knows exactly
#                        what will be released; versions are persisted to workspace
#   approve-release   - manual gate: review calculated versions before approving
#   release-gen-bsky  - release gen-bsky crate (sequential to avoid Cargo.lock conflicts)
#   release-gen-linkedin - release gen-linkedin crate
#   release-pcu       - release pcu crate
#   toolkit/release_prlog - create workspace v* release and update PRLOG.md

parameters:
  gen_bsky_version:
    type: string
    default: ""
    description: "Override gen-bsky crate version (empty = nextsv auto-detect)"
  gen_linkedin_version:
    type: string
    default: ""
    description: "Override gen-linkedin crate version (empty = nextsv auto-detect)"
  pcu_version:
    type: string
    default: ""
    description: "Override pcu crate version (empty = nextsv auto-detect)"
  workspace_version:
    type: string
    default: ""
    description: "Override workspace v* version (empty = nextsv auto-detect)"

orbs:
  toolkit: jerus-org/circleci-toolkit@4.5.4

jobs:
  tools:
    executor: toolkit/rust_env_rolling
    steps:
      - run:
          name: Verify tools
          command: |
            set -ex
            nextsv --version
            pcu --version
            cargo release --version
            jq --version
            rsign --version

workflows:
  release:
    jobs:
      - tools

      # Calculate versions BEFORE the approval gate so the reviewer knows
      # exactly what will be released. The approved versions are persisted to
      # the workspace and used unchanged by the release jobs after approval.
      - toolkit/calculate_versions:
          name: calculate-versions
          requires: [tools]
          crates: |
            gen-bsky:gen-bsky-v
            gen-linkedin:gen-linkedin-v
            pcu:pcu-v
          crate_version_overrides: |
            gen-bsky:<< pipeline.parameters.gen_bsky_version >>
            gen-linkedin:<< pipeline.parameters.gen_linkedin_version >>
            pcu:<< pipeline.parameters.pcu_version >>
          workspace_version_override: << pipeline.parameters.workspace_version >>

      - approve-release:
          type: approval
          requires: [calculate-versions]

      # Sequential release chain to avoid Cargo.lock conflicts.
      # Each job pushes via GitHub App before the next starts,
      # so the next checkout gets the latest committed state.
      - toolkit/release_crate:
          name: release-gen-bsky
          requires: [approve-release]
          package: gen-bsky
          crate_tag_prefix: gen-bsky-v
          context:
            - release
            - bot-check
            - pcu-app

      - toolkit/release_crate:
          name: release-gen-linkedin
          requires: [release-gen-bsky]
          package: gen-linkedin
          crate_tag_prefix: gen-linkedin-v
          context:
            - release
            - bot-check
            - pcu-app

      - toolkit/release_crate:
          name: release-pcu
          requires: [release-gen-linkedin]
          package: pcu
          crate_tag_prefix: pcu-v
          build_binary: true
          binary_name: pcu
          context:
            - release
            - bot-check
            - pcu-app

      - toolkit/release_prlog:
          requires: [release-pcu]
          context:
            - release
            - bot-check
            - pcu-app

version: 2.1

parameters:
  min_rust_version:
    type: string
    default: "1.87"
  fingerprint:
    type: string
    default: SHA256:OkxsH8Z6Iim6WDJBaII9eTT9aaO1f3eDc6IpsgYYPVg

orbs:
  toolkit: jerus-org/circleci-toolkit@4.0.1

jobs:
  tools:
    executor:
      name: toolkit/rust_env_rolling
    steps:
      - run:
          name: Verify tools
          command: |
            set -ex
            nextsv --version
            pcu --version
            cargo release --version
            gen-changelog --version
            jq --version

  release-crates:
    executor:
      name: toolkit/rust_env_rolling
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - << pipeline.parameters.fingerprint >>
      - toolkit/gpg_key
      - toolkit/git_config
      - run:
          name: Make scripts executable
          command: |
            chmod +x scripts/*.sh
            chmod +x crates/*/release-hook.sh
      # Phase 1: Release library crates (no internal dependencies)
      - run:
          name: Release gen-bsky (if needed)
          command: ./scripts/prepare-crate-release.sh gen-bsky gen-bsky-v crates/gen-bsky
      - run:
          name: Release gen-linkedin (if needed)
          command: ./scripts/prepare-crate-release.sh gen-linkedin gen-linkedin-v crates/gen-linkedin
      # Phase 2: Release dependent crates
      - run:
          name: Release pcu (if needed)
          command: ./scripts/prepare-crate-release.sh pcu pcu-v crates/pcu
      # Push all changes atomically
      - run:
          name: Push all releases
          command: |
            set -exo pipefail
            if git tag --points-at HEAD | grep -q .; then
              git push origin main --tags
            else
              echo "No new tags to push - skipping"
            fi

  release-prlog:
    executor:
      name: toolkit/rust_env_rolling
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - << pipeline.parameters.fingerprint >>
      - toolkit/gpg_key
      - toolkit/git_config
      - run:
          name: Detect and release PRLOG
          command: |
            set -exo pipefail
            chmod +x scripts/*.sh

            # Use standard v prefix for PRLOG (not prlog-v)
            BUMP=$(nextsv calculate --prefix "v" 2>/dev/null || echo "first")

            if [ "$BUMP" = "none" ]; then
              echo "No PRLOG release needed"
              exit 0
            fi

            if [ "$BUMP" = "first" ]; then
              # First release after switching to new system
              CURRENT=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "v0.6.3")
              VERSION=$(echo "$CURRENT" | sed 's/v//' | awk -F. '{print $1"."$2+1".0"}')
            else
              VERSION=$(nextsv --number calculate --prefix "v" | tail -1)
            fi

            ./scripts/release-prlog.sh "$VERSION"
            git push origin main --tags

workflows:
  release:
    jobs:
      - tools

      # Release all crates in dependency order within a single job
      - release-crates:
          requires: [tools]
          context:
            - release
            - bot-check

      # PRLOG release (after all crates released)
      - release-prlog:
          requires:
            - release-crates
          context:
            - release
            - bot-check
